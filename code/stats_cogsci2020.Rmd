---
title: 'Stats for CogSci2020 submission'
date: "Jan 2020"
output:
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, progress = TRUE)
```

```{r packageload, message=FALSE}
library(here)
library(tidyverse)
library(lme4)
library(RColorBrewer)
```


Read in the data frame that adds density to the variables Josh created. We currently include density in the visualizations but not the statistical analyses.

```{r readdata, message=FALSE}
df <- read_csv(here("code", "data", "df_zapotec_density.csv"))
````

Add variables we'll need for the analyses.

```{r preprocessing, message=FALSE}

slab <- function(z) {
  z[!(z %in% c("xlútsǐ", "càrpìntêr",  "msì", "bǎd",  "mtsùu", "wǐt", "dzǐn̲g"))] <-"other"
  z
}

df_mf <- df  %>% 
  mutate(is_named = !is.na(folk_specific), logmass = log(mass), logfreq = log(freq)) %>% 
  mutate(is_prot = !is.na(folk_specific) & folk_specific==folk_generic)  %>% 
  # XXX: should is_compound and name_length be based on specific or generic names?
  mutate(is_compound = grepl('-', folk_specific)) %>% 
  mutate(name_length = str_count(folk_specific) - is_compound) %>% 
  mutate(logname_length = log(name_length)) %>% 
  mutate(clements_group=factor(clements_group))  %>% 
  # XXX: include only species for which we have mass and frequency?
  filter(mass > 0 & freq > 0) %>% 
  mutate(name=factor(folk_generic)) %>% 
  mutate(name=fct_relabel(name, slab)) %>% 
  mutate(name=factor(name, levels =  c("dzǐn̲g", "xlútsǐ", "càrpìntêr",  "msì", "bǎd",  "mtsùu", "wǐt", "other"))) %>% 
  mutate(e1 = -e1)

  
# make long data frame for generating figures
df_mf_long <- df_mf %>% 
  gather(key='variable', value='val', logmass, logfreq, density)
```


## Prototype plots

```{r protype, message=FALSE}
protstatus <- df_mf %>% 
  select(folk_generic, is_prot) %>% 
  distinct() %>% 
  group_by(folk_generic) %>% 
  summarize(cnt = n()) %>% 
  ungroup() %>% 
  filter(cnt>1)

protcats <- inner_join(df_mf, protstatus)

protplot <- protcats %>% 
  filter(is_named) %>% 
  ggplot(aes(x = reorder(species, -freq), y = freq, color = is_prot)) +
  geom_col() +
  facet_wrap(~folk_generic, scale="free")  +
  theme(axis.text.x=element_blank())
 
protplot
```

## Morphospace
```{r morphospace, message=FALSE}


mycolors <- c(brewer.pal(n = 7, name = 'Dark2'), "#BDBDBD")

morphospace_plot <- df_mf %>% 
  filter(!is.na(e1) & is_named) %>% 
  ggplot(aes(x = e1, y = e2, shape=name, color = name)) +
  #scale_shape_manual(values=1:nlevels(df_mf$plotgen)) +
  scale_shape_manual(values=c(15,16,17,18,3,4,8, 1)) +
  scale_color_manual(values=mycolors) +
  geom_point() +
  coord_fixed() +
  theme_classic() + 
  theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.title = element_blank()) +
 #theme(plot.margin=grid::unit(c(0,0,0,0), "mm")) +
 theme(legend.position = "bottom", legend.spacing.x = unit(0.1, 'mm'))

morphospace_plot
ggsave( here("paper", "figures", "morphospace.png"), width=3.375, units="in")

```


## Named vs Unnamed categories

```{r namedunnamed, message=FALSE}

namedvsunnamed_plot <- df_mf_long %>% 
  ggplot(aes(x = is_named, y = val)) +
  geom_violin() +
  facet_wrap(~variable, scale="free")
namedvsunnamed_plot

naming_full <- glm( formula = is_named ~ logfreq + logmass,  family = binomial, data = df_mf)
naming_freq<- glm( formula = is_named ~ logfreq,  family = binomial, data = df_mf)
naming_mass<- glm( formula = is_named ~ logmass, family = binomial, data = df_mf)
anova(naming_freq, naming_full, naming_mass, test="Chisq")


naming_drop <- drop1(naming_full, test="Chisq")
summary(naming_full)
naming_drop
```

The coefficients suggest that logfreq is a strong predictor (0.84) but that logmass is not (-0.03). The call to `drop1` compares the full model against models that drop one of the predictors. Dropping logfreq means that the model fit gets significantly worse (p < 2e-16), but dropping logmass doesn't hurt the fit (p = 0.59). The AIC values support this conclusion (dropping logfreq makes the AIC bigger (ie worse), but dropping logmass makes the AIC a little bit better (smaller))

## Lumping analysis
Now we analyze how many other species each named species is lumped with. 

```{r lumping, message=FALSE}
df_named <- df_mf %>% 
  filter(is_named) %>% 
  mutate(norm_group_size_generic = group_size_folk_generics/group_size_clements) 

lumping_plot <- df_mf_long %>% 
  filter(is_named) %>% 
  ggplot(aes(x = val, y = group_size_folk_generics)) +
  geom_point() +
  geom_count() +
  scale_size_area()+
  geom_smooth(method=lm) +
  facet_wrap(~variable, scales="free")
lumping_plot

lmlumping_full <- lm( formula = group_size_folk_generics ~ logfreq + logmass,  data = df_named)
lmlumping_freq <- lm( formula = group_size_folk_generics ~ logfreq,  data = df_named)
lmlumping_mass <- lm( formula = group_size_folk_generics ~ logmass,  data = df_named)

anova(lmlumping_freq, lmlumping_full, lmlumping_mass, test="Chisq")
#lumping_drop <- drop1(lmlumping, test="Chisq")
#lumping_drop
summary(lmlumping_full)
```
The coefficients suggest that logmass (-1.22) is a stronger predictor than logfreq (-0.54). Dropping either predictor, however, leads to a model fit that is significantly worse (p values of 0.03 for logfreq and 1e-8 for logmass). AIC values support the same conclusion.

## Compound vs monomial


```{r compoundvsmonomial, message=FALSE}
compound_plot <- df_mf_long %>% 
  filter(is_named) %>% 
  ggplot(aes(x = is_compound, y = val)) +
  geom_violin(draw_quantiles=c(0.5)) +
  facet_wrap(~variable, scale="free")
compound_plot

logitmodcompound <- glm(
  formula = is_compound ~ logfreq + logmass, 
  family = binomial,
  data = df_named)

compound_drop <- drop1(logitmodcompound, test="Chisq")
compound_drop
summary(logitmodcompound)
```

Coefficients suggest that logfreq (-0.10) is a stronger predictor than logmass (-0.04) -- and the negative values indicating that if the frequency or mass of a species increase, it's *less* likely to have a compound name. But the `drop1` analyses suggest that model fit doesn't become significantly worse when either predictor is dropped (p values of 0.46 and 0.78). AIC scores support same conclusion.


## Name length

Suggest not including a figure for this, but just reporting in the text. Effect of frequency goes in opposite way compared to the compound vs monomial analysis (more common things have longer names)


```{r namelength, message=FALSE}

namelength_plot <- df_mf_long %>% 
  filter(is_named) %>% 
  ggplot(aes(x = val, y = logname_length)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(~variable, scale="free")
namelength_plot

namelength_full <- lm( formula = logname_length ~ logfreq + logmass,  data = df_named)
namelength_freq <- lm( formula = logname_length ~ logfreq,  data = df_named)
namelength_mass <- lm( formula = logname_length ~ logmass,  data = df_named)

#namelength_drop <- drop1(namelength_full, test="Chisq")
#namelength_drop

anova(namelength_freq, namelength_full, namelength_mass, test="Chisq")

summary(namelength_full)
```

Coefficients suggest that logfreq (0.04) and logmass (-0.06) are both weak predictors. Dropping logmass significantly impairs model performance (p = 0.02) but dropping logfreq doesn't (p = 0.2). AIC scores support same conclusion.

## Overall conclusions

#### Frequency

* decent evidence that frequency predicts whether or not a species is named
* only weak evidence that frequency predicts lumping
* no effect of frequency on compound vs monomial or name length

#### Mass

* replicate Hunn's finding that size predicts lumping (and find that it's a stronger predictor than frequency)
* only weak evidence that mass predicts anything else


#### Themes for discussion:

* reasons why we don't see a stronger effect of frequency  (discuss wrt theories that do predict frequency effects including functional/utilitarian view, Zipfian view, perhaps others)
* distribution of species in morphospace is an important confound in lumping, compound vs monomial and namelength analyses. Possible that similarity is the big thing: e.g if a species is very similar to many other species than we'd expect to have a high lumping score independent of mass and frequency, and might also expect to have a compound name that reflects the relationship of the species to other similar things. 
* Future direction: include similarity as predictor. Use the data in that recent paper  (Macroevolutionary convergence connects morphological form to ecological function in birds) to add a "neighborhood density" variable that captures how many other local species a given species is similar to.





## Caveats

This notebook is a quick attempt to generate results we can include in a minimal submittable draft. At some stage we should

* confirm that setting `test=Chisq` in the call to `drop1()` is what we actually want. 
* look at residuals and try other kinds of model-checking
* consider mixed effects analyses with random effects for Clemens group
 



